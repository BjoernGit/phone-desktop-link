<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>Phone â†” Desktop Link</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, sans-serif; padding: 24px; }
    .box { padding: 16px; border: 1px solid #ddd; border-radius: 12px; max-width: 720px; }
    .muted { opacity: 0.7; }
    code { background: #f5f5f5; padding: 2px 6px; border-radius: 6px; }
    #qr { margin-top: 12px; }
    #photos img { max-width: 100%; display: block; margin-top: 12px; border-radius: 12px; }
  </style>
</head>
<body>
  <h1>Phone â†” Desktop Link</h1>

  <div class="box" id="desktop" style="display:none">
    <h2>Desktop Mode ðŸ’»</h2>
    <p class="muted">Scanne den QR-Code mit dem Handy, um die Session zu koppeln.</p>
    <div><strong>Session:</strong> <code id="sessionText"></code></div>
    <canvas id="qr" width="256" height="256"></canvas>
    <div class="muted" style="margin-top:8px">
      Status: <span id="desktopStatus">â€¦</span>
    </div>
    <div id="photos"></div>
  </div>

  <div class="box" id="mobile" style="display:none">
    <h2>Mobile Mode ðŸ“±</h2>
    <div class="muted" id="mobileStatus">â€¦</div>
    <div style="margin-top:12px">
      <button id="startCamera">Kamera starten</button>
      <button id="takePhoto">Foto senden</button>
    </div>
    <video id="video" playsinline autoplay style="width:100%;max-height:60vh;margin-top:12px;background:#000;border-radius:12px;"></video>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

  <script>
    const isMobile =
      (navigator.userAgentData && navigator.userAgentData.mobile) ||
      /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

    const params = new URLSearchParams(window.location.search);
    let sessionId = params.get("session");

    function newSessionId() {
      return (crypto.randomUUID && crypto.randomUUID()) ||
        ("sess_" + Math.random().toString(16).slice(2) + Date.now().toString(16));
    }

    const socket = io();

    function joinSession(role) {
      if (!sessionId) return;
      socket.emit("join-session", { sessionId, role });
    }

    if (!isMobile) {
      if (!sessionId) {
        sessionId = newSessionId();
        const newUrl = `${window.location.origin}${window.location.pathname}?session=${encodeURIComponent(sessionId)}`;
        history.replaceState({}, "", newUrl);
      }

      document.getElementById("desktop").style.display = "block";
      document.getElementById("sessionText").textContent = sessionId;

      new QRious({
        element: document.getElementById("qr"),
        value: window.location.href,
        size: 256,
      });

      const statusEl = document.getElementById("desktopStatus");
      statusEl.textContent = "Warte auf Verbindungâ€¦";

      joinSession("desktop");

      socket.on("peer-joined", ({ role }) => {
        if (role === "mobile") statusEl.textContent = "Handy verbunden âœ…";
      });

      socket.on("peer-left", ({ role }) => {
        if (role === "mobile") statusEl.textContent = "Handy getrennt";
      });

      socket.on("photo", ({ imageDataUrl }) => {
        const img = document.createElement("img");
        img.src = imageDataUrl;
        document.getElementById("photos").prepend(img);
      });

    } else {
      document.getElementById("mobile").style.display = "block";
      const mobileStatus = document.getElementById("mobileStatus");

      if (!sessionId) {
        mobileStatus.textContent = "Keine Session. Bitte QR-Code vom Desktop scannen.";
      } else {
        mobileStatus.innerHTML = `Verbunden mit Session <code>${sessionId}</code> âœ…`;
        joinSession("mobile");
      }

      const video = document.getElementById("video");
      const startBtn = document.getElementById("startCamera");
      const takeBtn = document.getElementById("takePhoto");

      startBtn.addEventListener("click", async () => {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: "environment" },
          audio: false,
        });
        video.srcObject = stream;
      });

      takeBtn.addEventListener("click", () => {
        if (!sessionId) return;
        if (!video.videoWidth || !video.videoHeight) return;

        const canvas = document.createElement("canvas");
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;

        const ctx = canvas.getContext("2d");
        ctx.drawImage(video, 0, 0);

        const imageDataUrl = canvas.toDataURL("image/jpeg", 0.8);
        socket.emit("photo", { sessionId, imageDataUrl });
      });
    }
  </script>
</body>
</html>
